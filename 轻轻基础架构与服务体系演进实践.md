# 轻轻基础架构与服务体系演进实践

> “技术的本质：技术是对现象的有目的的编程。
>
> 技术的循环：技术总是进行这样的循环，为解决老问题去采用新技术，新技术又引起新问题，新问题的解决又要诉诸更新的技术。“
>
> -- 布莱恩·阿瑟



### **01背景**

  截止到2021年初，轻轻产品技术团队已经由初创期(2015)的数十人，发展到目前接近300人的产研团队；服务数量也有初创期的几个单体业务，发展到现在接近200多个服务的微服务体系；业务体系由最初的上门业务，拓展到目前1w多一对一用户同时在线上课的在线课堂业务。期间，轻轻基础服务体系作为业务系统的底层支持，从中也经历了从虚拟化、容器化到云原生化（初步体系）的演进，实现了基于混合云的融合部署架构。

作为基础服务体系迭代与演进的核心在于：“效率与赋能”，主要体现在一下几个方面：



**“多”：**支撑更多业务、更多研发人员、更大数据量，更多用户在线上课

**“快”：**支撑更快产品交付

**“好”：**保障用户体验和产品稳定可靠

**“省”：**提供工具优化流程，提高产品交付效率



在演进中，主要从以下几个方面去考虑实施方案：

**标准化：**制定统一标准规范

**简化：**

-  简化应用内的非业务逻辑
-  简化应用所处执行环境的搭建和维护
-  简化应用在不同周期阶段内的流转复杂度

**自助化服务：降低路径依赖，减少不必要流程**

**技术栈和组件选型原则**

- 选择经过实际生产环境验证的技术栈和组件
- 技术栈和组件要适合团队技术能力及主流技术方向
- 跟踪主流技术演进方向
- 适当预研相关技术方案并储备



当前轻轻基础服务体系，主要提供包括系统部署架构、高可用架构设计与优化(接入、计算、数据存储)、研发基础设施(代码仓库、持续集成、持续部署)、数据服务基础设施(数据库及存储服务，大数据基础设施、实时计算平台)，平台架构与工具服务(日志体系、监控与告警体系、数据可视化服务、基础框架服务、中间件服务、安全体系）、基础平台服务(硬件管理体系、虚拟化云平台、容器云平台)等服务，体系架构图如下：

![img](https://wework.qpic.cn/wwpic/417986_aGHJW-GmQ7qDOBi_1614303809/0?tp=webp)

基础服务体系架构图



### **02实践**

伴随轻轻业务持续发展，轻轻基础服务体系的演进节奏类似于建造一座大楼，经历了从初创期的“打地基”发展到现在“建管道”的阶段。

![img](https://wework.qpic.cn/wwpic/432346_xDZ5xpRtT2qbP5X_1614303809/0?tp=webp)

**1.1 初创期**

“打地基”：以支撑业务快速交付为主线，逐步构建基础服务层和统一技术栈与标准，保障产品快速灵活交付。

基础服务层：基于CLoustack构建虚拟化云管理平台，提供自助虚拟化云服务

部署架构：单线动态BGP接入，基于LVS/Nginx提供负载均衡服务

研发支撑： 统一代码仓库为GitLab，Jenkins提供编译打包，Zabbix提供监控与告警服务

**1.2 发展期**

“做框架”： 以DevOPS作为主线，在异构的底层设施上构建近似的应用执行环境，弱化业务应用对基础设施的直接感知，构建研发基础设施体系，基础工具链体系，大数据基础设施满足数据分析与增长需求；资源服务层也由虚拟化云逐渐演进到容器云架构

n 研发基础设施体系：研发基础设施提供研发工程体系支撑与软件交付流构建，提供从需求管理、项目管理、代码仓库、代码审计、代码扫描、持续测试、持续集成、持续部署等工具链与流程体系。构建从“需求->开发->测试->发布->运维”端到端的协同服务和研发工具，支持多种部署形态。

![img](https://wework.qpic.cn/wwpic/416601_8JMCwNMhTrutQq2_1614303809/0?tp=webp)

**研发基础设施体系架构图**

![img](https://wework.qpic.cn/wwpic/462646_WVJWcWNPQEupfqT_1614303809/0?tp=webp)

**CI/CD流程**

**大数据基础设施平台：**大数据基础设施平台由数据接入层、数据计算与服务层、数据应用层三个逻辑层次组成，数据基础设施平台旨在提供高效的开发工具，提升数据开发人员工作效率，提供完善的运维、监控能力，保证数据生产的正确性和时效性。

![img](https://wework.qpic.cn/wwpic/471030_RonmsFMbSx2clkc_1614303809/0?tp=webp)

**大数据体系架构图**

**容器云体系架构**：容器云体系由容器运行时Docker，容器编排Kubernetes，跨集群容器云管理平台Kubesphere组成

![img](https://wework.qpic.cn/wwpic/513411_pR99Pmz1SF2Q5Um_1614303809/0?tp=webp)

**基于Kubernetes容器云体系架构图**

技术实现与场景解析

-  **技术栈：**Kubernetes 1.18,Docker,Helm 3,Harbor,Kubesphere 3.0,Spinnaker,Jenkins
-  **技术实现**

A.  基于Jenkins等CI工具生成docker 镜像，存储于本地harbor镜像仓库，CD系统根据事件触发，同步镜像到IDC与公有云远程harbor镜像仓库实现基于镜像产出物交付机制和各K8s集群间接口

B.  Spinnaker基于helm实现应用服务对K8s集群服务注册与管理

![img](https://wework.qpic.cn/wwpic/522415_Uwf80iYwTNiLElj_1614303809/0?tp=webp)

**应用与K8s Ingress注册流**

C.  Kubesphere提供跨区域多集群K8s集群管理服务



**1.3 高速发展期（当前阶段）**

“建管道”：为解决在线课堂业务潮汐现象明显特点，引入混合云部署架构，支撑课堂业务系统弹性与扩展性；提供基础框架层应用，简化应用内的非业务逻辑和提高服务治理能力；优化接入层架构提高可用性，通过Helm，Habor等组件应用逐步提升云原生化能力

**部署架构：**基于混合云的部署模式；托管数据中心提供核心服务与大数据服务，公有云提供弹性计算服务与通用云产品服务



![img](https://wework.qpic.cn/wwpic/555876_zzkSNqfUTEm4F4d_1614303809/0?tp=webp)

**混合云部署架构**

![img](https://wework.qpic.cn/wwpic/569572_USbENpxJQuKIAVm_1614303809/0?tp=webp)

**网络拓扑架构**

-  服务器与设备托管于上海世纪互联纪蕴数据中心：部署轻轻所有核心系统（包括机器猫、轻轻课堂、大数据平台）
-  阿里云/腾讯云：提供CDN、GSLB(GTM)、对象存储、轻轻课堂视频录制、白板服务、人脸识别等AI基础服务、第三方服务托管
-  其它云服务：RTC(声网/好未来/即构)
- 南洋办公网机房：代码仓库/CI/CD服务，Dev/TST等服务
- **接入层：**轻轻接入层体系由DNS智能解析调度(阿里云服务)、GTM(全局流量管理系统，阿里云服务)、外网SLB(Server Load Balancer)系统(L4/L7：Nginx+ospf)、内网SLB系统(L4：LVS+OSPF，L7：Haproxy/Nginx/K8S Ingress控制器)组成。

![img](https://wework.qpic.cn/wwpic/589221_UxT5BWI1RP-zJOH_1614303809/0?tp=webp)

**接入层架构图**

 **特性与场景解析**

**A 全局解析与调度层**

\1. 智能DNS解析层提供基于运营商、地域、数据中心的DNS智能解析服务。对客户端访问世纪互联机房质量不好的用户，调度到阿里云/腾讯云提供代理模式。

\2.  GTM层提供基于网络/区域的智能解析，以ping方式对后端网络进行健康检查。提供基于静态BGP/动态BGP线路检查与自动切换。

\3.  外网SLB层，该层由nginx+ospf(开放式最短路径优先协议)构建，提供L4/L7层负责均衡调度，直接提供外网IP请求服务。外部客户端请求由外网SLB转发到内网SLB和K8S Ingress集群。

- 客户端请求链路：Client-> 外网SLB->K8s Ingress->App

\4.  内网负载均衡层，由L4 层LVS+ospf组成、L7层由haproxy/Nginx代理集群与K8s Ingress组成。

- 内网APP应用间访问链路， App->内网SLB->K8s Ingress->App
- 内网应用访问DB等基础服务访问链路，App->内网L4 SLB->L7 SLB->DB/ES->L7 SLB->App



### **03 基础框架与微服务治理**

服务治理体系

![img](https://wework.qpic.cn/wwpic/179218_NFdnASLWQQyfVK3_1614305642/640?tp=webp)

- l 客户端请求链路：`Client à外网SLBàK8s IngressàApp`
- l 客户端请求链路：`Client à外网SLBàK8s IngressàApp`
- l 客户端请求链路：`Client à外网SLBàK8s IngressàApp`

**服务自理体系**

**
**

**服务自理核心功能组件：**

- 服务发现
- 服务监控
- 弹性与容错：熔断；限流；降级；健康检查

**轻轻基础框架层**

- 体系架构

![img](https://wework.qpic.cn/wwpic/656829_apuJ0HPcSLuwjel_1614303809/0?tp=webp)

**轻轻基础框架体系架构**

- 技术实现与场景解析

- 服务发现：基于Kubernetes服务发现机制
- 服务监控

1. 日志：QingQingLogSDK实现日志采集与分发
2. 调用链：Skywalking
3. Metrics：基于Spring Boot定制改造micrometer实现metrics相关数据采集

- 弹性与容错

1. 熔断；限流；降级：sentinel
2. 监控：

-   Spring Boot定制 heathcheck，实现liveness与readiness probe提供容器健康度与服务健康度检查
-   AppDashboard实现容器健康度指标实时展现



### **04未来规划**

扩张期

“搭房间”：云原生架构深入，ServiceMesh框架应用，加速业务交付；基础框架层完善，中间件下沉到基础设施，简化应用内的非业务逻辑；数据计算实时化，Flink实时计算平台完善，提供自助服务，提高轻轻课堂监控能力从服务出发，管理人员、服务、资源三者之间的关系；DevOps体系从服务出发，管理人员、服务、资源三者之间的关系，简化应用在不同周期阶段内的流转复杂度。



轻轻架构 
接入服务层：网络、内网、外网、DNS解析

应用层：中台-机器猫，用户端APP，电脑客户端

中间件服务层：rebbitmq，redis，kafka，索引服务，分布式存储服务：

数据库服务层：mysql mongodb，

基础工具：Apollo，执行数据库脚本的QDB，日志服务，监控警告服务n9e